# drawpicture

```mermaid
flowchart TB

%% =========================================================
%% 输入与路径
%% =========================================================
A[用户输入：年终奖年份] --> B[生成 year_str / next_year / jan_str / feb_str]
B --> C[确定年终奖数据目录 base_dir]

%% =========================================================
%% 数据源读取（原始表）
%% =========================================================
subgraph S1[数据源读取（原始表）]

  H1[① 在职名单<br/>校机关非事编在职人员.xls<br/>字段：RYBH, XM, LXRQ, HTQSRQ]
  H2[data_htz<br/>RYBH→gzzh<br/>默认：是否年终奖=否<br/>备注=空]
  H1 --> H2

  J1[② 12月奖金结果<br/>year年12月奖金-结果-编外.xlsx<br/>字段：gzzh, xm]
  J2[data_jj_htz<br/>xm→12月奖金名单]
  J1 --> J2

  T1[③ 停薪名单<br/>year年校机关非事编停薪人员.xls<br/>字段：RYBH, XM, zjbh, txrq, bz]
  T2[data_tx_gz_full]
  T1 --> T2

  T3a[data_tx_gz_only_name<br/>仅 RYBH, XM<br/>重命名：RYBH→gzzh<br/>XM→xm]
  T3b[data_tx_gz<br/>全字段<br/>列名小写]
  T2 --> T3a
  T2 --> T3b

  T4[从身份证号提取出生日期<br/>计算推算年龄<br/>基准：年终奖年度12月31日]
  T3b --> T4

  D1[④ 新系统在职全名单.xlsx<br/>字段：工作证号、单位编号、单位简称]
  D2[data_dwbh_dwjc]
  D1 --> D2

  Q1[⑤ 次年1月起薪名单<br/>校机关合同制]
  Q2[data_gzqx_1yue]
  Q1 --> Q2

  R1[⑥ 次年2月起薪名单<br/>校机关非事编]
  R2[data_gzqx_2yue]
  R1 --> R2

end

%% =========================================================
%% 人员全集构建
%% =========================================================
H2 --> C1[在职 + 停薪人员合并]
T3a --> C1

C1 --> K1[与12月奖金名单比对<br/>key = gzzh]
J2 --> K1

K1 --> U1[只在12月奖金名单中的人员]
C1 --> C2[人员全集 data_all]
U1 --> C2

%% =========================================================
%% 信息补全（merge）
%% =========================================================
C2 --> M1[补单位信息]
D2 --> M1

M1 --> M2[补12月奖金信息]
J2 --> M2

M2 --> M3[补次年1月起薪信息]
Q2 --> M3

M3 --> M4[补次年2月起薪信息]
R2 --> M4

M4 --> M5[补停薪详细信息<br/>身份证、停薪日期、备注、推算年龄]
T3b --> M5
T4 --> M5

%% =========================================================
%% 年终奖资格判定
%% =========================================================
M5 --> P1{是否在12月奖金名单？}

P1 -- 是 --> P1a[发放年终奖<br/>备注：12月奖金名单]

P1 -- 否 --> P2{停薪备注含“退休”？}
P2 -- 是 --> P2a[发放年终奖<br/>备注：停薪退休]

P2 -- 否 --> P3{推算年龄 ≥ 55<br/>且存在停薪日期？}
P3 -- 是 --> P3a[发放年终奖<br/>备注：疑似退休]

P3 -- 否 --> P4[不发放年终奖]

%% =========================================================
%% 特殊修正 & PRZTM
%% =========================================================
P1a --> X1
P2a --> X1
P3a --> X1
P4 --> X1

X1[计算编号类别<br/>来源：工作证号]

X1 --> X2[64派遣人员特殊修正<br/>强制发放]

X2 --> Y1{是否发放年终奖？}
Y1 -- 否 --> Y1a[PRZTM 为空]

Y1 -- 是 --> Y2{是否退休？}
Y2 -- 是 --> Y2a[PRZTM = 23]

Y2 -- 否 --> Y3{编号类别 = 62 或 88}
Y3 -- 是 --> Y3a[PRZTM = 21]

Y3 -- 否 --> Y4{编号类别 = 64}
Y4 -- 是 --> Y4a[PRZTM = 22]
Y4 -- 否 --> Y4b[PRZTM 为空]

%% =========================================================
%% 导出结果
%% =========================================================
Y2a --> Z[导出年终奖名单 Excel]
Y3a --> Z
Y4a --> Z
Y1a --> Z
Y4b --> Z

