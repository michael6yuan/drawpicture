# drawpicture

```mermaid
flowchart TB

%% =========================================================
%% 输入与路径
%% =========================================================
A[用户输入：年终奖年份 year_nzj] --> B[生成 year_str / next_year / jan_str / feb_str]
B --> C[base_dir = D:\03-年终奖\{year_str}年终综合奖\0名单梳理\校机关非事编\]

%% =========================================================
%% 数据源（读取）
%% =========================================================
subgraph S1[数据源读取（原始表）]

  H1[① 在职名单\n校机关非事编在职人员.xls\n字段：RYBH, XM, LXRQ, HTQSRQ]
  H2[data_htz\nRYBH→gzzh\n默认：是否年终奖=否\n备注=空]
  H1 --> H2

  J1[② 12月奖金结果\n{year_str}年12月奖金-结果-编外.xlsx\n字段：gzzh, xm]
  J2[data_jj_htz\nxm→12月奖金名单]
  J1 --> J2

  T1[③ 停薪名单\n{year_str}年校机关非事编停薪人员.xls\n字段：RYBH, XM, zjbh, txrq, bz…]
  T2[data_tx_gz_full]
  T1 --> T2

  T3a[data_tx_gz_only_name\n仅 RYBH, XM\n重命名：RYBH→gzzh\nXM→xm]
  T3b[data_tx_gz\n全字段\n列名小写]
  T2 --> T3a
  T2 --> T3b

  T4[从 zjbh 提取出生日期\n计算 推算年龄\n基准：year_nzj-12-31]
  T3b --> T4

  D1[④ 新系统在职全名单.xlsx\n字段：工作证号/人员编号\n单位编号\n单位简称]
  D2[data_dwbh_dwjc\ngzzh, dwbh, dwjc]
  D1 --> D2

  Q1[⑤ 次年1月起薪名单\n{jan_str}校机关合同制起薪名单.xls]
  Q2[data_gzqx_1yue\n1月工资起薪信息]
  Q1 --> Q2

  R1[⑥ 次年2月起薪名单\n{feb_str}校机关非事编起薪名单.xls]
  R2[data_gzqx_2yue\n2月工资起薪信息]
  R1 --> R2

end

%% =========================================================
%% 人员全集构建
%% =========================================================
H2 --> C1[在职 + 停薪人员合并\nconcat]
T3a --> C1

C1 --> K1[datacompy 比对\n在职+停薪 vs 12月奖金\nkey = gzzh]
J2 --> K1

K1 --> U1[只在12月奖金名单\n不在在职/停薪]
K1 --> U2[只在在职/停薪\n不在12月奖金]

C1 --> C2[人员全集 data_all]
U1 --> C2

%% =========================================================
%% 信息补全（merge / vlookup）
%% =========================================================
C2 --> M1[merge 单位信息\ndwbh / dwjc]
D2 --> M1

M1 --> M2[merge 12月奖金名单]
J2 --> M2

M2 --> M3[merge 1月起薪]
Q2 --> M3

M3 --> M4[merge 2月起薪]
R2 --> M4

M4 --> M5[merge 停薪全信息\nzjbh / txrq / bz / 推算年龄]
T3b --> M5
T4 --> M5

%% =========================================================
%% 是否年终奖判定逻辑
%% =========================================================
M5 --> P1{是否在12月奖金名单？}

P1 -- 是 --> P1a[是否年终奖=是\n备注+=在12月奖金名单]

P1 -- 否 --> P2{停薪备注 bz 含“退休”？}
P2 -- 是 --> P2a[是否年终奖=是\n备注+=停薪退休]

P2 -- 否 --> P3{推算年龄 ≥ 55\n且 有停薪日期？}
P3 -- 是 --> P3a[是否年终奖=是\n备注+=停薪且年龄≥55\n疑似退休]

P3 -- 否 --> P4[是否年终奖=否]

%% =========================================================
%% 特殊人员修正 & PRZTM
%% =========================================================
P1a --> X1
P2a --> X1
P3a --> X1
P4 --> X1

X1[计算 编号类别\n=gzzh[4:6]]

X1 --> X2[64派遣特殊名单修正\n强制发放\n备注+=派遣]

X2 --> Y1{是否年终奖=是？}
Y1 -- 否 --> Y1a[PRZTM=空]

Y1 -- 是 --> Y2{是否退休？}
Y2 -- 是 --> Y2a[PRZTM=23]

Y2 -- 否 --> Y3{编号类别=62 / 88}
Y3 -- 是 --> Y3a[PRZTM=21]

Y3 -- 否 --> Y4{编号类别=64}
Y4 -- 是 --> Y4a[PRZTM=22]
Y4 -- 否 --> Y4b[PRZTM=空]

%% =========================================================
%% 导出
%% =========================================================
Y2a --> Z[导出 Excel\n年终奖名单筛选-校机关非事编_{year_str}.xlsx]
Y3a --> Z
Y4a --> Z
Y1a --> Z
Y4b --> Z

